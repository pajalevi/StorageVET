---
title: "R Notebook"
output:
  html_notebook:
    code_folding: hide
---

Examining the results of changing the number of days in which the state of charge of the battery is managed:

```{r message=FALSE, warning=FALSE}
library(plyr)
library(tidyverse)
library(stringr)
resultsfolder = "/Applications/storagevet2v101/StorageVET-master-git/Results/"

if(T){
  source("/Applications/storagevet2v101/StorageVET-master-git/combine_results.R")
  output = combine_results(runIDs = c(86:93,95:114), savecsv=F, plotTF=F) #41:48, 78:85, or 86:93. last two are with optimistic baseline, difference is daily cycle cap: second set doesnt have one
} else {
  # output = read_csv(file = paste0(resultsfolder,"npv_runs78-85.csv"))
  output = read_csv(file = paste0(resultsfolder,"npv_runs41-48.csv"))
}
dark2scale =c('#1b9e77','#d95f02','#7570b3','#e7298a','#66a61e','#e6ab02','#a6761d','#666666',"#2f4f4f")
scale = (c("#2f4f4f","#8b4513","#228b22","#000080","#ff0000","#ffff00","#00ff00","#00ffff","#ff00ff","#eee8aa","#6495ed","#ff69b4"))
# runslog = read_csv(file = paste0(resultsfolder,"runsLog.csv"))
# output = merge(output, runslog[,c("runID","shortname", "description")], by = "runID")


output$ITC = output$`2MW-5hr Capital Cost` * 0.26
fivehbatt = output$shortname != "baseline1_4hbatt"
output$SGIP[fivehbatt] = 10000 * 250 * -1
output$SGIP[!fivehbatt] = 8000 * 250 * -1
output$unsub_total = output$total
output$total = output$unsub_total - output$ITC - output$SGIP #subsidies are negative so that they show up against capital cost
output$`2MW-5hr Capital Cost` = output$`2MW-5hr Capital Cost` - output$ITC - output$SGIP

```

Stacked Revenue of baseline runs and constrained runs
```{r}
talloutput = pivot_longer(output, cols = c(-runID,-total,-outputfol,-shortname,-description,-unsub_total),names_to = "value_type", values_to = "value")  #removed -keyFn
  talloutput$name = substr(talloutput$outputfol,10,100)
  tallrevenue = filter(talloutput,value>0)
  ggplot(tallrevenue,aes(fill = value_type, x = reorder(shortname,-total), y = value)) +
    geom_bar(position="stack", stat = "identity") +
    # geom_hline(yintercept = 0, color = "black") + 
    theme_minimal() + 
    # theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=1)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
    scale_y_continuous(labels = scales::dollar_format()) +
    scale_fill_manual(values = dark2scale)
    #scale_fill_brewer(palette = "Dark2") # +
```

Those changes are pretty hard to detect. How does the total revenue change?
```{r}
# output_constrained = output[output$runID %in% c(42,44,46,48),]
output_constrained = output[output$runID%%2 == 1,]
output_constrained = output[str_sub(output$outputfol,-4,-1)!="days",]
output_constrained$Num_RA_Events = NA
for(i in 1:nrow(output_constrained)){
  # ID which run was used to generate constraints for this run
  input_runID = as.numeric(substr(str_split(output_constrained$outputfol[i],"_")[[1]][3],6,100))
  input_run_sel = which(output$runID == input_runID)
  
  # ID num RA events for that run
  numevents = str_remove_all(str_sub(output$outputfol[input_run_sel],-7,-5),"[^0-9]")
  
  # fill in
  output_constrained$Num_RA_Events[i] = numevents
}
# output_constrained$Num_RA_Events = (str_remove_all(str_sub(output_constrained$outputfol,-7,-5),"[^0-9]")) # removes all nonnumeric characters
ggplot(output_constrained,aes(x=reorder(Num_RA_Events,-total), y = total)) + geom_col() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Total NPV", x="Number of days with RA events")
```

How does unsubsidized NPV change?
```{r}
ggplot(output_constrained,aes(x=reorder(Num_RA_Events,-unsub_total), y =unsub_total)) + geom_col() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Unsubsidized Total NPV", x="Number of days with RA events")
```

Overall revenue, expeniture changes
```{r}
tallbaseline = pivot_longer(output_constrained, cols = c(-runID,-total,-unsub_total,-outputfol,-shortname,-description,-Num_RA_Events),names_to = "value_type", values_to = "value")  #removed -keyFn
# tallbaseline$name = substr(talloutput$outputfol,10,100)
#tallbaseline$value_type = ordered(tallbaseline$value_type, levels = rev(c("DA ETS","FR Energy Throughput","Regulation Up","Regulation Down","Spinning Reserves","Non-Spinning Reserves",
                                                                        # "Resource AdequacyCapacity Payment", "2MW-5hr Capital Cost","2MW-5hr Fixed O&M Cost","2MW-5hr Variable O&M Costs",
                                                                        # "Site Load Capital Cost","Site Load Fixed O&M Cost",
                                                                        # "Aux Load Cost","ITC","SGIP")))
valuescale =c("light grey","cornsilk",'#1b9e77','#666666',"#2f4f4f","#8b4513",'#e7298a','#d95f02','#7570b3','#66a61e',"#228b22",'#e6ab02','#a6761d',"#6495ed","#000080")
ggplot(tallbaseline ,aes(x = reorder(Num_RA_Events, -total), y = value, fill = value_type)) +
    geom_bar(stat = "identity") +
    geom_hline(yintercept = 0, color = "black") +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust=1)) +
    scale_y_continuous(labels = scales::dollar_format()) +
    scale_fill_manual(values=valuescale)
```


By what fraction does NPV decrease from 10 days to 40 days?
```{r}
totdiff = output_constrained$total[1]-output_constrained$total[4]
diff_pct = (totdiff)/output_constrained$total[1]
print(diff_pct)

totdiff2=output_constrained$unsub_total[1]-output_constrained$unsub_total[4]
diff_pct2 = (totdiff2)/output_constrained$unsub_total[1]
print(diff_pct2)
```

Decreasing the threshold at which SOC management happens from 10 to 40 days results in a `r round(100*diff_pct,3)`% decrease in revenue. If we exclude the subsidies, thats a `r round(100*diff_pct2,3)`% decrease. the total difference is $`r round(totdiff2,3)`.
Of course, we need to re-run these results with new assumptions that have been sanity checked.

By what fraction does NPV decrease from 0 days to 365 days?
```{r}
min_row = which.min(as.numeric(output_constrained$Num_RA_Events))
max_row = which.max(as.numeric(output_constrained$Num_RA_Events))
totdiff = output_constrained$total[min_row]-output_constrained$total[max_row]
diff_pct = (totdiff)/output_constrained$total[min_row]
print(diff_pct)

totdiff2=output_constrained$unsub_total[min_row]-output_constrained$unsub_total[max_row]
diff_pct2 = (totdiff2)/output_constrained$unsub_total[min_row]
print(diff_pct2)
```

Decreasing the threshold at which SOC management happens from 10 to 365 days results in a `r round(100*diff_pct,3)`% decrease in revenue. If we exclude the subsidies, thats a `r round(100*diff_pct2,3)`% decrease. the total difference is $`r round(totdiff2,3)`.
Of course, we need to re-run these results with new assumptions that have been sanity checked.

<!-- Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*. -->

<!-- When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).  -->

<!-- The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed. -->

